<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Mis Citas | MediPlus</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="/img/Mediplus logo.png">

  <style>
    body {
        background-color: #E0F2FF;
        min-height: 100vh;
        font-family: Arial, sans-serif;
    }

    .content {
        margin-left: 260px;
        padding: 40px;
    }

    .title {
        text-align: center;
        margin-bottom: 30px;
        font-size: 28px;
        font-weight: bold;
    }

    .cita-card {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        transition: transform 0.2s;
    }

    .cita-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .badge-custom {
        font-size: 14px;
        padding: 8px 15px;
    }

    .alert-floating {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 350px;
        animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .btn-cancelar {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 8px;
        transition: background-color 0.3s;
    }

    .btn-cancelar:hover:not(:disabled) {
        background-color: #c82333;
    }

    .btn-cancelar:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
    }

    .cita-info {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .info-row {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .info-label {
        font-weight: bold;
        color: #555;
        min-width: 120px;
    }
  </style>
</head>

<body>

<!-- Sidebar Paciente -->
<div th:insert="~{layout/sidebar-paciente :: sidebar}"></div>

<!-- Contenido Principal -->
<div class="content">

  <div class="title">üìÖ Mis Citas M√©dicas</div>

  <div class="container">

    <!-- Mensaje si no hay citas -->
    <div th:if="${#lists.isEmpty(citas)}" class="alert alert-info text-center">
      <h5>No tienes citas programadas</h5>
      <p>Agenda tu primera cita para recibir atenci√≥n m√©dica</p>
      <a href="/front/citas/agendar" class="btn btn-primary mt-3">Agendar Cita</a>
    </div>

    <!-- Lista de Citas -->
    <div th:each="cita : ${citas}" class="cita-card">
      <div class="d-flex justify-content-between align-items-start">

        <!-- Informaci√≥n de la cita -->
        <div class="cita-info flex-grow-1">
          <div class="info-row">
            <span class="info-label">üè• Especialidad:</span>
            <span th:text="${cita.especialidad}"></span>
          </div>

          <div class="info-row">
            <span class="info-label">üìÖ Fecha:</span>
            <span th:text="${cita.fecha}"></span>
          </div>

          <div class="info-row">
            <span class="info-label">üïê Hora:</span>
            <span th:text="${cita.hora}"></span>
          </div>

          <div class="info-row">
            <span class="info-label">üìã Estado:</span>
            <span th:if="${cita.estado == 'PROGRAMADA'}" class="badge bg-success badge-custom">‚úÖ Programada</span>
            <span th:if="${cita.estado == 'CANCELADA'}" class="badge bg-danger badge-custom">‚ùå Cancelada</span>
            <span th:if="${cita.estado == 'COMPLETADA'}" class="badge bg-info badge-custom">‚úîÔ∏è Completada</span>
          </div>
        </div>

        <!-- Bot√≥n de cancelar -->
        <div class="ms-3">
          <button
                  th:if="${cita.estado == 'PROGRAMADA'}"
                  th:attr="data-cita-id=${cita.id}"
                  class="btn btn-cancelar btnCancelar"
                  onclick="confirmarCancelacion(this)">
            Cancelar Cita
          </button>

          <span
                  th:if="${cita.estado == 'CANCELADA'}"
                  class="badge bg-secondary badge-custom">
                        Cita cancelada
                    </span>
        </div>
      </div>

      <!-- Mensaje de advertencia para citas pr√≥ximas -->
      <div th:if="${cita.estado == 'PROGRAMADA'}" class="alert alert-warning mt-3 mb-0">
        <small>
          ‚ö†Ô∏è <strong>Importante:</strong> Solo puedes cancelar con al menos 12 horas de anticipaci√≥n.
          Recibir√°s un correo de confirmaci√≥n al cancelar.
        </small>
      </div>
    </div>

    <!-- Bot√≥n volver -->
    <div class="text-center mt-4">
      <a href="/home/paciente" class="btn btn-secondary px-4">Volver al Inicio</a>
    </div>

  </div>

</div>

<!-- Modal de Confirmaci√≥n -->
<div class="modal fade" id="modalConfirmacion" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">‚ö†Ô∏è Confirmar Cancelaci√≥n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>¬øEst√°s seguro de que deseas cancelar esta cita?</p>
        <div class="alert alert-info">
          <small>
            üìß Se enviar√° un correo de confirmaci√≥n de cancelaci√≥n a tu email registrado.
          </small>
        </div>
        <p class="text-muted">
          <small>Al cancelar, el horario quedar√° disponible para otros pacientes.</small>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, mantener cita</button>
        <button type="button" class="btn btn-danger" id="btnConfirmarCancelacion">S√≠, cancelar</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  let citaIdACancelar = null;
  const modal = new bootstrap.Modal(document.getElementById('modalConfirmacion'));

  // Funci√≥n para mostrar alertas flotantes
  function mostrarAlerta(mensaje, tipo = 'success') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${tipo} alert-dismissible fade show alert-floating`;
      alertDiv.innerHTML = `
          ${mensaje}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alertDiv);

      setTimeout(() => {
          alertDiv.remove();
      }, 6000);
  }

  // Confirmar cancelaci√≥n
  function confirmarCancelacion(button) {
      citaIdACancelar = button.getAttribute('data-cita-id');
      modal.show();
  }

  // Ejecutar cancelaci√≥n
  document.getElementById('btnConfirmarCancelacion').addEventListener('click', function() {
      if (!citaIdACancelar) return;

      const btn = this;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Cancelando...';

      fetch(`/front/citas/${citaIdACancelar}/cancelar`, {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          }
      })
      .then(async response => {
          const data = await response.json();

          if (response.ok) {
              modal.hide();
              mostrarAlerta('‚úÖ ' + data.mensaje, 'success');

              // Recargar la p√°gina despu√©s de 2 segundos
              setTimeout(() => {
                  window.location.reload();
              }, 2000);
          } else {
              modal.hide();
              mostrarAlerta('‚ùå ' + (data.mensaje || 'Error al cancelar la cita'), 'danger');
              btn.disabled = false;
              btn.innerHTML = 'S√≠, cancelar';
          }
      })
      .catch(error => {
          console.error('Error:', error);
          modal.hide();
          mostrarAlerta('‚ùå Error de conexi√≥n al cancelar la cita', 'danger');
          btn.disabled = false;
          btn.innerHTML = 'S√≠, cancelar';
      });
  });

  // Resetear al cerrar el modal
  document.getElementById('modalConfirmacion').addEventListener('hidden.bs.modal', function () {
      citaIdACancelar = null;
      document.getElementById('btnConfirmarCancelacion').disabled = false;
      document.getElementById('btnConfirmarCancelacion').innerHTML = 'S√≠, cancelar';
  });
</script>

</body>
</html>