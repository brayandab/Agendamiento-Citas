<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Agendar Cita | MediPlus</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="/img/Mediplus logo.png">

    <style>
        body {
            background-color: #E0F2FF;
            min-height: 100vh;
            font-family: Arial, sans-serif;
            color: #333;
        }

        .content {
            margin-left: 260px;
            padding: 40px;
        }

        .title {
            text-align: center;
            margin-bottom: 40px;
            font-size: 32px;
            font-weight: bold;
            color: #0a3d62; /* Azul oscuro visible */
            text-shadow: 1px 1px 3px rgba(0,0,0,0.2); /* Le da contraste */
        }

        .card-custom {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .btn-back {
            margin-top: 20px;
        }

        .alert-floating {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body>

<!-- Sidebar Paciente -->
<div th:insert="~{layout/sidebar-paciente :: sidebar}"></div>

<!-- Contenido Principal -->
<div class="content">

    <div class="title">üìù Agendar Cita</div>

    <div class="container">

        <!-- Selecci√≥n de Especialidad -->
        <div class="card-custom mb-3">
            <label class="form-label fw-bold">Selecciona la especialidad</label>
            <select id="especialidadSelect" class="form-select">
                <option value="">-- Selecciona una especialidad --</option>
                <option value="MEDICINA_GENERAL">Medicina General</option>
                <option value="ODONTOLOGIA">Odontolog√≠a</option>
                <option value="PEDIATRIA">Pediatr√≠a</option>
                <option value="DERMATOLOGIA">Dermatolog√≠a</option>
            </select>
        </div>

        <!-- Doctores -->
        <div class="card-custom mb-3 d-none" id="doctoresCard">
            <label class="form-label fw-bold">Doctores disponibles</label>
            <select id="doctorSelect" class="form-select">
                <option value="">-- Selecciona un doctor --</option>
            </select>

            <div id="doctoresSpinner" class="text-center mt-2 d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>

        <!-- Horarios -->
        <div class="card-custom d-none" id="horariosCard">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="fw-bold mb-0">Horarios disponibles</h5>
                <button id="refreshBtn" class="btn btn-sm btn-outline-primary">
                    üîÑ Actualizar
                </button>
            </div>

            <div id="horariosSpinner" class="text-center mt-2 d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>

            <div id="horariosContainer" class="mb-3"></div>

            <button id="agendarBtn" class="btn btn-success w-100" disabled>Agendar cita</button>
        </div>

        <!-- ID Paciente -->
        <input type="hidden" id="pacienteId" th:value="${pacienteId}">

        <div class="text-center btn-back">
            <a href="/home/paciente" class="btn btn-secondary px-4">Volver</a>
        </div>

    </div>

</div>

<script>
    const especialidadSelect = document.getElementById("especialidadSelect");
    const doctorSelect = document.getElementById("doctorSelect");
    const doctoresCard = document.getElementById("doctoresCard");
    const horariosCard = document.getElementById("horariosCard");
    const horariosContainer = document.getElementById("horariosContainer");
    const doctoresSpinner = document.getElementById("doctoresSpinner");
    const horariosSpinner = document.getElementById("horariosSpinner");
    const agendarBtn = document.getElementById("agendarBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const pacienteId = document.getElementById("pacienteId").value;

    let selectedAgenda = null;

    // Funci√≥n para mostrar alertas flotantes
    function mostrarAlerta(mensaje, tipo = 'success') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${tipo} alert-dismissible fade show alert-floating`;
        alertDiv.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    // Cargar doctores por especialidad
    especialidadSelect.addEventListener("change", function () {
        const esp = this.value;
        if (!esp) return;

        doctorSelect.innerHTML = `<option value="">-- Selecciona un doctor --</option>`;
        horariosContainer.innerHTML = "";
        horariosCard.classList.add("d-none");
        agendarBtn.disabled = true;
        selectedAgenda = null;
        doctoresSpinner.classList.remove("d-none");

        fetch(`/front/citas/doctores?especialidad=${esp}`)
            .then(r => r.json())
            .then(doctores => {
                if (doctores.length === 0) {
                    mostrarAlerta('No hay doctores disponibles para esta especialidad', 'warning');
                    return;
                }

                doctores.forEach(doc => {
                    doctorSelect.innerHTML += `
                        <option value="${doc.id}">
                            Dr(a). ${doc.usuario.nombre} ${doc.usuario.apellido} - Consultorio ${doc.consultorio}
                        </option>`;
                });
                doctoresCard.classList.remove("d-none");
            })
            .catch(err => {
                console.error("Error cargando doctores", err);
                mostrarAlerta('Error al cargar doctores', 'danger');
            })
            .finally(() => doctoresSpinner.classList.add("d-none"));
    });

    // Funci√≥n para cargar horarios (reutilizable)
    function cargarHorarios() {
        const doctorId = doctorSelect.value;
        if (!doctorId) return;

        horariosContainer.innerHTML = "";
        agendarBtn.disabled = true;
        selectedAgenda = null;
        horariosSpinner.classList.remove("d-none");

        fetch(`/front/agenda/doctor/${doctorId}/simple`)
            .then(r => {
                if (!r.ok) {
                    throw new Error(`HTTP error! status: ${r.status}`);
                }
                return r.json();
            })
            .then(agendas => {
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);

                let horariosDisponibles = 0;

                agendas.forEach(a => {
                    const fechaAgenda = new Date(a.fecha);
                    const btn = document.createElement("button");
                    btn.className = "btn w-100 my-2";
                    btn.textContent = `${a.fecha} ‚Äî ${a.horaInicio} a ${a.horaFin}`;

                    if (a.disponible && fechaAgenda >= hoy) {
                        horariosDisponibles++;
                        btn.classList.add("btn-outline-primary");
                        btn.addEventListener("click", () => {
                            horariosContainer.querySelectorAll("button").forEach(b => {
                                b.classList.remove("btn-primary");
                                b.classList.add("btn-outline-primary");
                            });
                            btn.classList.remove("btn-outline-primary");
                            btn.classList.add("btn-primary");
                            selectedAgenda = a;
                            agendarBtn.disabled = false;
                        });
                    } else {
                        btn.classList.add("btn-secondary");
                        btn.disabled = true;
                        if (!a.disponible) {
                            btn.textContent += " (Ocupado)";
                        } else {
                            btn.textContent += " (Pasado)";
                        }
                    }

                    horariosContainer.appendChild(btn);
                });

                if (horariosDisponibles === 0) {
                    horariosContainer.innerHTML = `
                        <div class="alert alert-warning">
                            No hay horarios disponibles para este doctor.
                        </div>`;
                }
            })
            .catch(err => {
                console.error("Error cargando agenda:", err);
                horariosContainer.innerHTML = `
                    <div class="alert alert-danger">
                        Error al cargar horarios. Por favor intenta de nuevo.
                    </div>`;
                mostrarAlerta('Error al cargar horarios', 'danger');
            })
            .finally(() => horariosSpinner.classList.add("d-none"));
    }

    // Cargar horarios al seleccionar doctor
    doctorSelect.addEventListener("change", function () {
        if (!this.value) return;
        horariosCard.classList.remove("d-none");
        cargarHorarios();
    });

    // Bot√≥n de actualizar horarios
    refreshBtn.addEventListener("click", cargarHorarios);

    // Agendar cita
    agendarBtn.addEventListener("click", function () {
        if (!selectedAgenda) {
            mostrarAlerta('Por favor selecciona un horario', 'warning');
            return;
        }

        const doctorId = doctorSelect.value;
        agendarBtn.disabled = true;
        agendarBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Agendando...';

        // ‚úÖ Obtener nombre del doctor seleccionado
        const doctorOption = doctorSelect.options[doctorSelect.selectedIndex];
        const nombreDoctor = doctorOption.text;

        // Convertir hora a formato HH:mm (sin segundos)
        const horaFormateada = selectedAgenda.horaInicio.substring(0, 5);

        const cita = {
            pacienteId: parseInt(pacienteId),
            medicoId: parseInt(doctorId),
            especialidad: especialidadSelect.value,
            fecha: selectedAgenda.fecha,
            hora: horaFormateada,
            // Estos datos se obtendr√°n del servidor desde la sesi√≥n
            // El backend buscar√° el email y nombre del paciente
        };

        console.log('Enviando cita:', cita); // Para debugging

        fetch("/front/citas/agendar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(cita)
        })
            .then(async r => {
                const responseText = await r.text();
                console.log('Respuesta del servidor:', responseText); // Para debugging

                let responseData;
                try {
                    responseData = responseText ? JSON.parse(responseText) : {};
                } catch (e) {
                    responseData = {};
                }

                if (r.ok) {
                    mostrarAlerta('‚úÖ Cita agendada correctamente', 'success');
                    selectedAgenda = null;
                    // Recargar horarios autom√°ticamente despu√©s de 1 segundo
                    setTimeout(() => {
                        cargarHorarios();
                    }, 1000);
                } else if (r.status === 409) {
                    // Conflicto - horario ya no disponible
                    mostrarAlerta('‚ö†Ô∏è ' + (responseData.mensaje || 'Este horario ya fue tomado por otro paciente'), 'warning');
                    cargarHorarios(); // Recargar para mostrar actualizaci√≥n
                } else if (r.status === 404) {
                    mostrarAlerta('‚ùå ' + (responseData.mensaje || 'Horario no encontrado'), 'danger');
                    cargarHorarios();
                } else if (r.status === 400) {
                    mostrarAlerta('‚ùå ' + (responseData.mensaje || 'Datos inv√°lidos'), 'danger');
                    agendarBtn.disabled = false;
                } else if (r.status === 500) {
                    mostrarAlerta('‚ùå Error en el servidor. Por favor intenta de nuevo', 'danger');
                    agendarBtn.disabled = false;
                } else {
                    mostrarAlerta('‚ùå Error al agendar la cita: ' + (responseData.mensaje || 'Error desconocido'), 'danger');
                    agendarBtn.disabled = false;
                }
            })
            .catch(err => {
                console.error('Error completo:', err);
                mostrarAlerta('‚ùå Error de conexi√≥n al agendar la cita', 'danger');
                agendarBtn.disabled = false;
            })
            .finally(() => {
                agendarBtn.innerHTML = 'Agendar cita';
            });
    });
</script>

</body>
</html>