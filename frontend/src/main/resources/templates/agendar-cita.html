<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Agendar Cita</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-4">

    <h2 class="mb-4">Agendar Cita</h2>

    <!-- SELECCIÓN DE ESPECIALIDAD -->
    <div class="card mb-3">
        <div class="card-body">
            <label class="form-label fw-bold">Selecciona la especialidad</label>
            <select id="especialidadSelect" class="form-select">
                <option value="">-- Selecciona una especialidad --</option>
                <option value="MEDICINA_GENERAL">Medicina General</option>
                <option value="ODONTOLOGIA">Odontología</option>
                <option value="PEDIATRIA">Pediatría</option>
                <option value="DERMATOLOGIA">Dermatología</option>
            </select>
        </div>
    </div>

    <!-- DOCTORES -->
    <div class="card mb-3 d-none" id="doctoresCard">
        <div class="card-body">
            <label class="form-label fw-bold">Doctores disponibles</label>
            <select id="doctorSelect" class="form-select">
                <option value="">-- Selecciona un doctor --</option>
            </select>
            <div id="doctoresSpinner" class="text-center mt-2 d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- HORARIOS -->
    <div class="card d-none" id="horariosCard">
        <div class="card-body">
            <h5 class="fw-bold">Horarios disponibles</h5>
            <div id="horariosSpinner" class="text-center mt-2 d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
            <div id="horariosContainer" class="mb-3"></div>
            <button id="agendarBtn" class="btn btn-success w-100" disabled>Agendar cita</button>
        </div>
    </div>

    <input type="hidden" id="pacienteId" th:value="${pacienteId}">

</div>

<script>
    const especialidadSelect = document.getElementById("especialidadSelect");
    const doctorSelect = document.getElementById("doctorSelect");
    const doctoresCard = document.getElementById("doctoresCard");
    const horariosCard = document.getElementById("horariosCard");
    const horariosContainer = document.getElementById("horariosContainer");
    const doctoresSpinner = document.getElementById("doctoresSpinner");
    const horariosSpinner = document.getElementById("horariosSpinner");
    const agendarBtn = document.getElementById("agendarBtn");
    const pacienteId = document.getElementById("pacienteId").value;

    let selectedAgenda = null;

    especialidadSelect.addEventListener("change", function () {
        const esp = this.value;
        if (!esp) return;

        doctorSelect.innerHTML = `<option value="">-- Selecciona un doctor --</option>`;
        horariosContainer.innerHTML = "";
        horariosCard.classList.add("d-none");
        agendarBtn.disabled = true;
        doctoresSpinner.classList.remove("d-none");

        fetch(`/front/citas/doctores?especialidad=${esp}`)
            .then(r => r.json())
            .then(doctores => {
                doctores.forEach(doc => {
                    doctorSelect.innerHTML += `
                        <option value="${doc.id}">
                            Dr(a). ${doc.usuario.nombre} ${doc.usuario.apellido} - Consultorio ${doc.consultorio}
                        </option>`;
                });
                doctoresCard.classList.remove("d-none");
            })
            .catch(err => console.error("Error cargando doctores", err))
            .finally(() => doctoresSpinner.classList.add("d-none"));
    });

    doctorSelect.addEventListener("change", function () {
        const doctorId = this.value;
        if (!doctorId) return;

        horariosContainer.innerHTML = "";
        horariosCard.classList.remove("d-none");
        agendarBtn.disabled = true;
        selectedAgenda = null;
        horariosSpinner.classList.remove("d-none");

        fetch(`/front/agenda/doctor/${doctorId}/simple`)
            .then(r => r.json())
            .then(agendas => {
                const hoy = new Date();
                agendas.forEach(a => {
                    const fechaAgenda = new Date(a.fecha);
                    const btn = document.createElement("button");
                    btn.className = "btn w-100 my-2";
                    btn.textContent = `${a.fecha} — ${a.horaInicio} a ${a.horaFin}`;

                    if (a.disponible && fechaAgenda >= hoy) {
                        btn.classList.add("btn-outline-primary");
                        btn.addEventListener("click", () => {
                            horariosContainer.querySelectorAll("button").forEach(b => {
                                b.classList.remove("btn-primary");
                                b.classList.add("btn-outline-primary");
                            });
                            btn.classList.remove("btn-outline-primary");
                            btn.classList.add("btn-primary");
                            selectedAgenda = a;
                            agendarBtn.disabled = false;
                        });
                    } else {
                        // Deshabilitar si ya fue elegida
                        btn.classList.add("btn-secondary");
                        btn.disabled = true;
                    }

                    horariosContainer.appendChild(btn);
                });

                if (!horariosContainer.innerHTML) {
                    horariosContainer.innerHTML = `<p class="text-muted">No hay horarios disponibles.</p>`;
                }
            })
            .catch(err => {
                console.error("Error cargando agenda", err);
                horariosContainer.innerHTML = `<p class="text-danger">Error cargando horarios.</p>`;
            })
            .finally(() => horariosSpinner.classList.add("d-none"));
    });

    agendarBtn.addEventListener("click", function () {
        if (!selectedAgenda) return;

        const doctorId = doctorSelect.value;

        const cita = {
            pacienteId: parseInt(pacienteId),
            medicoId: parseInt(doctorId),
            especialidad: especialidadSelect.value,
            fecha: selectedAgenda.fecha,
            hora: selectedAgenda.horaInicio,
            estado: "PROGRAMADA"
        };

        fetch("/front/citas/agendar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(cita)
        })
        .then(r => {
            if (r.ok) {
                alert("Cita agendada correctamente");
                doctorSelect.dispatchEvent(new Event("change"));
                agendarBtn.disabled = true;
            } else {
                alert("Error al agendar la cita");
            }
        })
        .catch(err => {
            console.error(err);
            alert("Error al agendar la cita");
        });
    });
</script>

</body>
</html>
